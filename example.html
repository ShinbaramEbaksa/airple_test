<!DOCTYPE html>
<html>
<head>
  <title>시설 지도</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 600px;
      margin-bottom: 20px;
    }
    #chartContainer {
      width: 80%;
      margin: auto;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="chartContainer">
    <canvas id="lineChart"></canvas>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    var map = L.map('map').setView([51.505, -0.09], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    var facilityData = [
      { id: 1, name: "Facility 1", lat: 51.505, lon: -0.09 },
      { id: 2, name: "Facility 2", lat: 51.515, lon: -0.1 }
    ];

    facilityData.forEach(function(facility) {
      var marker = L.marker([facility.lat, facility.lon]).addTo(map)
        .bindPopup(facility.name);

      marker.on('click', function() {
        fetch(`/api/sensors/${facility.id}`)
          .then(response => response.json())
          .then(data => {
            updateChart(data);
          });
      });
    });

    // 임의의 데이터로 차트를 업데이트하는 함수
    function updateChart(data) {
      var labels = data.map((_, index) => `Time ${index + 1}`);
      var values = data.map(item => item.waterLevel);

      var ctx = document.getElementById('lineChart').getContext('2d');
      if (window.myChart) {
        window.myChart.destroy();
      }
      window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Water Level (m)',
            data: values,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    // 임의의 데이터 생성 (서버 API 대신)
    function getMockSensorData() {
      return Array.from({ length: 10 }, () => ({ waterLevel: Math.floor(Math.random() * 101) }));
    }

    // mock data fetch를 대체
    window.fetch = (url) => {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve({
            json: () => Promise.resolve(getMockSensorData())
          });
        }, 1000);
      });
    };
  </script>
</body>
</html>
